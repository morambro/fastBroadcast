\section{Implementation}
\label{sec:implementation}

Our application is structured in different modules, each performing a specific function. 
Throughout the classes' hierarchy there's just one Activity\footnote{Entry point of our Android application. For other information about \ttt{Activity} class visit \url{http://developer.android.com/guide/components/activities.html}}; it's called \ttt{FastBroadcastActivity} and —at application startup— performs graphical initializations and creates the application controller. This controller is represented by \ttt{AppController} class which provides the interface \ttt{IAPPConttoller}; this controller creates a new \textit{broadcast receiver}\footnote{For informations abour what a broadcast receiver is, visit \url{http://developer.android.com/reference/android/content/BroadcastReceiver.html}}, which is an instance of \ttt{FastBroadcastReceiver} class.

%There is a single Activity class\footnote{Entry point of our Android application. For other information on Activity class visit \url{http://developer.android.com/guide/components/activities.html}}, called \ttt{FastBroadcastActivity}, which at application startup performs graphical initializations, creates the application controller, represented by class \ttt{AppController}, which implements \ttt{IAppController} interface, and initializes broadcast receiver\footnote{For information abour what a broadcast receiver is, visit \url{http://developer.android.com/reference/android/content/BroadcastReceiver.html}}, represented by \ttt{FastBroadcastReceiver} class.

%**************************************************************** HELPER ************************************************
\subsection{Helper}
Packege \ttt{it.unipd.fast.broadcast.helper} contains an helper class \ttt{XMLParser}. This class provides static methods to manage XML strings and extract information from them.

%************************************************************** LOCATION ************************************************
\subsection{Location}

//TODO

%*********************************************************** WI-FI CONNECTION ********************************************
\subsection{WI-FI Connection}
The component which manages WI-FI connection is contained in the package 
\begin{center}
	\ttt{it.unipd.fast.broadcast.wifi\_connection}
\end{center} 
It is composed by four subpackages:
	\\
	\subsubsection{\ttt{message}}
	This package contains \ttt{IMessage} abstract class, representing a generic message. It offers methods to create and add content to the message, and to retrieve easily message type, recipient and sender identificators, and content (as a reference to a \ttt{java.util.Map}'s subclass instance). It also offers two static methods:
	\begin{itemize}
		\item \ttt{String concatContent(String...content)} which returns a string obtained by the concatenation of strings contained in \ttt{content} array.
		\item \ttt{String[] splitContent(String s)} which splits the given string based on a static separator \ttt{CHAR\_SEPARATOR}. 
	\end{itemize}
	In our implementation, we use XML messages exchange. They are represented by \ttt{XMLMessage} subclass, which implements \ttt{IMessage} abstract methods to build XML string and extract information from them. To facilitate message building we introduced a singleton class \ttt{MessageBuilder}, which provides few methods to create \ttt{XMLMessage} instances.
	\hfill\\
	\subsubsection{\ttt{receiver}}
	This package contains classes used:
	\begin{itemize}
		\item to listen for broadcast WI-FI Intents\footnote{For a description of what an intent is, refer to \url{http://developer.android.com/reference/android/content/Intent.html}} generated by Android operating system;
		\item to receive data from other devices.
	\end{itemize}
	
	The first operation is performed by previously mentioned \ttt{FastBroadcastReceiver} class. This class extends \ttt{android.content.BroadcastReceiver} class. The method \ttt{void onReceive(final Context context, Intent intent)} is called when an intent is broadcasted, so in our redefinition it discrimnates from different intent types:
	\begin{itemize}
		\item WIFI\_P2P\_STATE\_CHANGED\_ACTION \hfill \\
		indicates whether device's WI-FI p2p funcion is enabled or not; if is enabled, peers discovering is requested via \direct APIs, otherwise a dialog is shown to the user, telling him to enable it.
		\item WIFI\_P2P\_PEERS\_CHANGED\_ACTION \hfill \\
		is generated when WI-FI device finds new peers (is executed after requesting peers discovering). If this intent is received, peers list is requested to \direct framework.
		\item WIFI\_P2P\_CONNECTION\_CHANGED\_ACTION \hfill \\
		is generated when a connection or a disconnection occours. If curent device is connected it means he belongs to a \direct group, so is asked to \direct framework for connection information.
		\item WIFI\_P2P\_THIS\_DEVICE\_CHANGED\_ACTION \hfill \\
		indicates WI-FI state changed, so is asked \direct framework to start peers discovering.		
	\end{itemize}

All the requests from \direct framework are \textit{asynchronous}, like Intent broadcasting; listeners are required to let the application be notified, so they are passed to \ttt{BroadcastReceiver}'s contructor by \ttt{AppController}.
	
	The second task is achieved by \ttt{DataReceiverService} which implements \ttt{IDataReceiverService} and \ttt{Runnable} interfaces, and extends \ttt{android.app.Service}. This class represents an Android service which listens on port 8888 for incoming TCP connection. When a TCP connection is opened, it handles it on a separate thread, to enable multiple requests handling. When a message arrives as a string, is converted to an \ttt{XMLMessage} instance using \ttt{MessageBuilder}, and passed to all registered handlers (instances of \ttt{IDataCollectionHandler} interface); hadlers registration is made with \ttt{registerHandler} method.
	\ttt{CollectionHandler} class is a specific \ttt{IDataCollectionHandler} implementation. His method \ttt{onDataCollected(IMessage message, String hostIp)} depending on received message's type calls different \ttt{IAppController} operations. Parameter \ttt{hostIp} contains the string representation of sender IP address: this information is used when a \textbf{Ping} message arrives to update peers addresses map.
	\\
	\subsubsection{\ttt{connectionmanager}}
	This package's classes are used to handle connection information, requested to \direct framework. These information are given in the form of a \ttt{android.net.wifi.p2p.WifiP2pInfo} instance; this class provides methods to obtain group owner's IP address, and to know if the current device is the group owner: this information is very important because depending whether the device is group owner or not, different operation has to be done. Class \ttt{ConnectionInfoManager} implementing \ttt{IConnectionInfoManager} manage this situation: it is passed as an handler to \direct framework, which calls \ttt{onConnectionInfoAvailable(WifiP2pInfo info)} asynchronously. 
	If the current device is not a group owner, it have to send a \textbf{Ping} message to the owner, including his MAC address in it.
	These operation are done on a separate thread, to prevent application stops on blocking operations.
	\\
	\subsubsection{\ttt{transmissionmanager}}
	This package contains classes used to send out messages to other devices. \ttt{ITransmissionManager} interface provides methods to send a message to a single device (based on a generic String id) or to a devices list. His implementation class \ttt{TcpTransmissionManager} use TCP Sockets to send out messages, performing it on a separate thread. To obtain a \ttt{TcpTransmissionManager} instance, is provided the sigleton class \ttt{TransmissionManagerFactory}.

%**********************************************************PROTOCOL ************************************************
\subsection{Protocol implementation}

Package \begin{center}\ttt{it.unipd.fast.broadcast.\\protocol\_implementation}\end{center} represents Fast Broadcast protocol implementation. It provides an interface \ttt{ICommunicationHandler} used by controller to communicate with this component. Class \ttt{FastBroadcastService} realize the protocol. It implements \ttt{ICommunicationHandler} interface and extends \ttt{android.app.Service}. \ttt{FastBroadcastService} has two inner private classes:
\begin{itemize}
	\item \ttt{HelloMessageSender}, a \ttt{java.util.TimerTask} subclass which realize \textbf{Hello} message sending. This task is scheduled at a fixed time $T$: it waits for a random time between $0$ and $T$ and if no other \textbf{Hello} message was sent (it checks whether \ttt{helloMessageArrived} is \ttt{true} or not), it broadcasts it.
	\item \ttt{MessageForwarder}, a thread class used to perform message forwarding (\textit{Broadcast phase}). It has a synchronized message queue on which this thread waits until \ttt{IMessage} instances are added. When a message arrives it calculates \textit{contention window} and waits a random time after which forwarding it (if no one else did it first). After forwarding the message, it calls \ttt{doOnForwarded} method, to update devices positions.
\end{itemize} 

The method \ttt{helloMessageReceived(IMessage message)} is called by the controller when an \textbf{Hello} arrives. It sets \ttt{helloMessageArrived} field to \ttt{true} and performs range hestimation on a separate thread.

%******************************************************** CONTROLLER ************************************************
\subsection{Controller}

Class \ttt{AppController} implements \ttt{IAppController} interface and is responsable of coordinating all application components. It defines methods callable from the application activity and from other classes to react to asynchronous events. This class defines several inner classes:
	\subsubsection{android.content.ServiceConnection implementations} This classes are used to handle asynchronous Android services creation:
		\begin{itemize}
			\item \ttt{LocServiceConnection} is used for localization service creation. When the service is created, a \ttt{LocationListener} implementation is setted, to receive location changes updates.  
			\item \ttt{DataServiceConnection} is used to create \ttt{DataReceiverService}. On service creation, a \ttt{CollectionHandler} instance is setted.
			\item \ttt{FastBroadcastServiceConnection} is used to create \ttt{FastBroadcastService}. When the service is created, current location and an handler implementation are setted.   
		\end{itemize}  
